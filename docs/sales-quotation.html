<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiệm gốm Inari - Báo giá</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
            }

            .store-name {
                font-size: 1.8em !important;
            }

            .info-section div {
                font-size: 0.9em !important;
                word-break: break-word;
            }

            th, td {
                font-size: 0.85em;
                padding: 8px 4px;
            }

            .product-image {
                width: 80px !important;
                height: 80px !important;
            }

            .total-row, .final-total {
                font-size: 1em !important;
                padding: 10px !important;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .logo {
            width: 100px;
            height: auto;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .store-name {
            color: #d32f2f;
            font-size: 2.5em;
            font-weight: bold;
        }

        .info-section {
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .info-section div {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-label {
            font-weight: bold;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #333;
            padding: 12px;
            text-align: center;
            white-space: nowrap;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
            font-size: 1.1em;
        }

        .product-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
        }

        @media (max-width: 768px) {
            table {
                min-width: 500px;
            }

            th, td {
                white-space: normal;
                word-break: break-word;
            }
        }

        .total-row {
            text-align: right;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3e0;
        }

        .final-total {
            text-align: right;
            font-size: 1.5em;
            font-weight: bold;
            color: #d32f2f;
            margin-top: 10px;
            padding: 15px;
            background-color: #ffebee;
        }

        .stt-col { width: 8%; }
        .image-col { width: 20%; }
        .quantity-col { width: 12%; }
        .unit-col { width: 15%; }
        .price-col { width: 15%; }
        .total-col { width: 20%; }

        .share-button {
            margin-top: 30px;
            text-align: center;
        }

        .share-btn {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
        }

        .share-btn:hover {
            background: #b71c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
        }

        .share-btn:active {
            transform: translateY(0);
        }

        .share-btn:disabled {
            background: #ddd;
            cursor: not-allowed;
            color: #999;
        }

        .message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .message.success {
            background: #f0f9f4;
            color: #1e7e34;
            border-left: 4px solid #28a745;
            display: block;
        }

        .message.error {
            background: #fef5f5;
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
            display: block;
        }

        .message.info {
            background: #fefaf0;
            color: #856404;
            border-left: 4px solid #ffc107;
            display: block;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Parse URL parameters
        function getUrlParams() {
            // Get the full URL to handle proper decoding on all browsers
            const fullUrl = window.location.href;
            const queryIndex = fullUrl.indexOf('?');

            if (queryIndex === -1) {
                return {
                    address: '',
                    phone: '',
                    bank_info: '',
                    sub_total: '',
                    grand_total: '',
                    items_info: '',
                    items_image: ''
                };
            }

            // Helper function to extract parameter value
            function getParam(paramName) {
                const paramPattern = new RegExp(`[?&]${paramName}=([^&]*)`);
                const match = fullUrl.match(paramPattern);
                if (!match) return '';

                let decoded = decodeURIComponent(match[1]);

                // Check if still URL-encoded (double-encoding issue)
                // If we find %XX patterns, decode again
                if (decoded.includes('%')) {
                    try {
                        decoded = decodeURIComponent(decoded);
                    } catch (e) {
                        // If second decode fails, use first decode result
                    }
                }

                return decoded;
            }

            // Special handling for items_image which may contain & characters
            let itemsImageValue = '';
            const itemsImageIndex = fullUrl.indexOf('items_image=');
            if (itemsImageIndex !== -1) {
                const afterItemsImage = fullUrl.substring(itemsImageIndex + 12); // 12 = 'items_image='.length
                const endMatch = afterItemsImage.match(/&(sub_total|grand_total)=/);
                let rawValue = endMatch ? afterItemsImage.substring(0, endMatch.index) : afterItemsImage;

                itemsImageValue = decodeURIComponent(rawValue);

                // Check if still URL-encoded (double-encoding issue)
                if (itemsImageValue.includes('%')) {
                    try {
                        itemsImageValue = decodeURIComponent(itemsImageValue);
                    } catch (e) {
                        // If second decode fails, use first decode result
                    }
                }
            }

            return {
                address: getParam('address'),
                phone: getParam('phone'),
                bank_info: getParam('bank_info'),
                sub_total: getParam('sub_total'),
                grand_total: getParam('grand_total'),
                items_info: getParam('items_info'),
                items_image: itemsImageValue
            };
        }

        // Parse items from custom format
        // Format: name:value|quantity:value|unit:value|unit_price:value|line_total:value , next_item...
        function parseItems(itemsInfoStr, itemsImageStr) {
            if (!itemsInfoStr) return [];

            try {
                // Split items by comma
                const itemsArr = itemsInfoStr.split(' , ').map(s => s.trim());

                // For image URLs, we need to handle the case where & characters might be split
                // Reconstruct full URLs by looking for URL patterns
                let imagesArr = [];
                if (itemsImageStr) {
                    // Split by comma (with optional spaces) which separates different image URLs
                    // Handle both " , " and "," formats
                    imagesArr = itemsImageStr.split(/\s*,\s*/).map(s => s.trim()).filter(s => s.length > 0);
                }

                return itemsArr.map((itemStr, index) => {
                    const item = {};

                    // Split by pipe to get key:value pairs
                    const pairs = itemStr.split('|');

                    pairs.forEach(pair => {
                        const colonIndex = pair.indexOf(':');
                        if (colonIndex > 0) {
                            const key = pair.substring(0, colonIndex).trim();
                            const value = pair.substring(colonIndex + 1).trim();
                            item[key] = value;
                        }
                    });

                    // Add image URL if available
                    if (imagesArr[index]) {
                        item.image_url = imagesArr[index];
                    }

                    return item;
                });
            } catch (e) {
                console.error('Error parsing items:', e);
                return [];
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount);
        }

        // Cache for images
        let imageFilesCache = [];
        let imageBlobUrlsCache = [];

        // Fetch image from URL and convert to File object
        async function fetchImageAsFile(imageUrl, index) {
            console.log(`Fetching image ${index + 1}:`, imageUrl);

            try {
                const response = await fetch(imageUrl, {
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const blob = await response.blob();

                if (blob.size === 0) {
                    throw new Error('Received empty image data');
                }

                let filename = `product-${index + 1}.jpg`;

                try {
                    const urlObj = new URL(imageUrl);
                    const fileNameParam = urlObj.searchParams.get('fileName');
                    if (fileNameParam) {
                        const parts = fileNameParam.split('/');
                        filename = parts[parts.length - 1];
                        filename = decodeURIComponent(filename);
                    }
                } catch (urlError) {
                    console.warn('Could not parse filename from URL:', urlError);
                }

                let fileType = blob.type;
                if (!fileType || fileType === 'application/octet-stream') {
                    const ext = filename.split('.').pop().toLowerCase();
                    const mimeTypes = {
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'png': 'image/png',
                        'gif': 'image/gif',
                        'webp': 'image/webp'
                    };
                    fileType = mimeTypes[ext] || 'image/jpeg';
                }

                const file = new File([blob], filename, { type: fileType });
                return file;
            } catch (error) {
                console.error(`Error fetching image ${index + 1}:`, error);
                return null; // Return null instead of throwing to allow partial success
            }
        }

        // Populate the page with data
        async function populateData() {
            const params = getUrlParams();

            // Update contact information
            document.getElementById('address').textContent = params.address;
            document.getElementById('phone').textContent = params.phone;
            document.getElementById('bank_info').textContent = params.bank_info;

            // Parse and populate items
            const items = parseItems(params.items_info, params.items_image);
            const tbody = document.getElementById('items-tbody');

            if (items.length > 0) {
                tbody.innerHTML = ''; // Clear existing rows

                // Extract image URLs
                const imageUrls = items.map(item => item.image_url).filter(url => url);

                // Fetch all images and cache them
                if (imageUrls.length > 0) {
                    showMessage(`Loading ${imageUrls.length} product images...`, 'info');

                    const imageFiles = await Promise.all(
                        imageUrls.map((url, idx) => fetchImageAsFile(url, idx))
                    );

                    // Convert to data URLs instead of blob URLs to avoid tainted canvas
                    for (const file of imageFiles) {
                        if (file) {
                            const dataUrl = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.readAsDataURL(file);
                            });
                            imageFilesCache.push(file);
                            imageBlobUrlsCache.push(dataUrl); // Using data URL instead of blob URL
                        }
                    }

                    showMessage('Images loaded successfully!', 'success');
                }

                let calculatedTotal = 0;
                let imageIndex = 0;

                items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const lineTotal = parseInt(item.line_total) || (parseInt(item.quantity) * parseInt(item.unit_price));
                    calculatedTotal += lineTotal;

                    // Use cached blob URL if available
                    let imgSrc = 'placeholder.jpg';
                    if (item.image_url && imageBlobUrlsCache[imageIndex]) {
                        imgSrc = imageBlobUrlsCache[imageIndex];
                        imageIndex++;
                    }

                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><img src="${imgSrc}" alt="${item.name || ''}" class="product-image" onerror="this.style.display='none'"></td>
                        <td>${item.quantity || 1}</td>
                        <td>${item.unit || ''}</td>
                        <td>${formatCurrency(parseInt(item.unit_price) || 0)} đ</td>
                        <td>${formatCurrency(lineTotal)} đ</td>
                    `;

                    tbody.appendChild(row);
                });

                // Update totals
                const subTotal = params.sub_total ? parseInt(params.sub_total) : calculatedTotal;
                const grandTotal = params.grand_total ? parseInt(params.grand_total) : subTotal;

                document.getElementById('sub_total').textContent = `${formatCurrency(subTotal)} đ`;
                document.getElementById('grand_total').textContent = `${formatCurrency(grandTotal)} đ`;
            } else if (params.sub_total && params.grand_total) {
                // If no items but totals provided, just update totals
                document.getElementById('sub_total').textContent = `${formatCurrency(parseInt(params.sub_total))} đ`;
                document.getElementById('grand_total').textContent = `${formatCurrency(parseInt(params.grand_total))} đ`;
            }
        }

        // Run on page load
        window.addEventListener('DOMContentLoaded', populateData);

        // Cache for captured image
        let capturedImageCache = null;
        let capturedImagePromise = null;

        // Capture DOM as image and cache it
        async function getCapturedImageOnce() {
            if (capturedImageCache) return capturedImageCache;
            if (capturedImagePromise) return capturedImagePromise;

            const container = document.querySelector('.container');

            capturedImagePromise = (async () => {
                try {
                    showMessage('Creating quotation image...', 'info');

                    // Hide the share button and logo during capture
                    const shareButtonDiv = document.querySelector('.share-button');
                    const logoImg = document.querySelector('.logo');

                    if (shareButtonDiv) {
                        shareButtonDiv.style.display = 'none';
                    }
                    if (logoImg) {
                        logoImg.style.display = 'none';
                    }

                    // Detect mobile devices
                    const isMobile = window.innerWidth <= 768;

                    // Get current container dimensions
                    const currentWidth = container.offsetWidth;

                    // Wait for data URL images to fully load
                    const images = container.querySelectorAll('.product-image');
                    await Promise.all(Array.from(images).map(img => {
                        if (img.complete) return Promise.resolve();
                        return new Promise(resolve => {
                            img.onload = resolve;
                            img.onerror = resolve;
                        });
                    }));

                    // Wait a bit more for layout to settle
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Capture with html2canvas at current width but higher scale for mobile
                    const canvas = await html2canvas(container, {
                        backgroundColor: '#ffffff',
                        scale: isMobile ? 4 : 2,  // Much higher scale for mobile to compensate for smaller width
                        logging: true,
                        useCORS: false,
                        allowTaint: true,
                        width: currentWidth,
                        windowWidth: currentWidth
                    });

                    // Show the share button and logo again
                    if (shareButtonDiv) {
                        shareButtonDiv.style.display = 'block';
                    }
                    if (logoImg) {
                        logoImg.style.display = 'block';
                    }

                    // Convert canvas to blob
                    const blob = await new Promise((resolve, reject) => {
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Failed to create image blob'));
                            }
                        }, 'image/png', 0.95);
                    });

                    // Create File object
                    const file = new File([blob], 'inari-quotation.png', { type: 'image/png' });

                    capturedImageCache = file;
                    return file;
                } catch (error) {
                    console.error('Error capturing image:', error);
                    throw error;
                }
            })();

            try {
                return await capturedImagePromise;
            } finally {
                capturedImagePromise = null;
            }
        }

        // Share functionality
        async function captureAndShare() {
            const shareBtn = document.getElementById('shareBtn');

            try {
                shareBtn.disabled = true;

                // Get or create the captured image
                const imageFile = await getCapturedImageOnce();

                // Check if Web Share API is supported
                if (!navigator.share) {
                    showMessage('Sharing is not supported. Downloading image instead...', 'info');

                    // Fallback: Download the image
                    const url = URL.createObjectURL(imageFile);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = imageFile.name;
                    a.click();
                    URL.revokeObjectURL(url);

                    setTimeout(() => {
                        showMessage('Image downloaded successfully!', 'success');
                    }, 500);

                    shareBtn.disabled = false;
                    return;
                }

                // Prepare share data
                const shareData = {
                    title: 'Tiệm gốm Inari - Báo giá',
                    files: [imageFile]
                };

                // Check if files can be shared
                if (navigator.canShare && !navigator.canShare(shareData)) {
                    showMessage('Your browser cannot share images. Downloading instead...', 'info');

                    const url = URL.createObjectURL(imageFile);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = imageFile.name;
                    a.click();
                    URL.revokeObjectURL(url);

                    shareBtn.disabled = false;
                    return;
                }

                // Share the image
                await navigator.share(shareData);
                showMessage('Quotation shared successfully!', 'success');

            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('Share cancelled', 'info');
                } else {
                    console.error('Error sharing:', error);
                    showMessage('Error: ' + error.message, 'error');
                }
            } finally {
                shareBtn.disabled = false;
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;

            // Auto-hide success/info messages after 3 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageDiv.className = 'message';
                }, 3000);
            }
        }

        // Add event listener to share button
        window.addEventListener('DOMContentLoaded', () => {
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', captureAndShare);
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">        
            <img src="logo.svg" alt="Tiệm gốm Inari Logo" class="logo">
            <h1 class="store-name">Tiệm gốm Inari</h1>
        </div>

        <div class="info-section">
            <div><span class="info-label">Địa chỉ:</span> <span id="address"></span></div>
            <div><span class="info-label">Số điện thoại:</span> <span id="phone"></span></div>
            <div><span class="info-label">Thông tin tài khoản:</span> <span id="bank_info"></span></div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th class="stt-col">STT</th>
                        <th class="image-col">Hình ảnh</th>
                        <th class="quantity-col">Số lượng</th>
                        <th class="unit-col">Đơn vị</th>
                        <th class="price-col">Giá</th>
                        <th class="total-col">Tổng</th>
                    </tr>
                </thead>
                <tbody id="items-tbody">
                </tbody>
            </table>
        </div>

        <div class="total-row">
            <span id="sub_total"></span>
        </div>

        <div class="final-total">
            Tổng + Ship (Free) &nbsp;&nbsp; <span id="grand_total"></span>
        </div>

        <div class="share-button">
            <button id="shareBtn" class="share-btn">Share Quotation</button>
            <div id="message" class="message"></div>
        </div>
    </div>
</body>
</html>
